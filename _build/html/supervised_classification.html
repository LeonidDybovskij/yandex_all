
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Customer churn &#8212; Data Science course</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'supervised_classification';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Selection of a location for a well" href="oil_bootstrap.html" />
    <link rel="prev" title="Tariff recommendation" href="tariff_recommendation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Data Science course</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Data Science course
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="credit_scoring.html">Credit scoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="real_estate_market_analysis.html">Real estate market analysis in St. Petersburg</a></li>
<li class="toctree-l1"><a class="reference internal" href="tariff_stats.html">Tariff statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_games.html">Analysis of the computer games market</a></li>
<li class="toctree-l1"><a class="reference internal" href="tariff_recommendation.html">Tariff recommendation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Customer churn</a></li>
<li class="toctree-l1"><a class="reference internal" href="oil_bootstrap.html">Selection of a location for a well</a></li>
<li class="toctree-l1"><a class="reference internal" href="gold_recovery.html">Gold recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_transformation.html">Protection of customers’ personal data</a></li>

<li class="toctree-l1"><a class="reference internal" href="cars_boosting.html">Cars cost determination</a></li>
<li class="toctree-l1"><a class="reference internal" href="taxi_time_series.html">Taxi orders prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="text_classification.html">Classification of comments</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision.html">Age prediction by photo</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression_metallurgy.html">Steel temperature prediction</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/supervised_classification.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Customer churn</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection">Feature selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-values">Missing values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding">One-hot encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#samples">Samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-scaling">Data scaling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-functions">Selection functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-without-balancing">Training without balancing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-with-balancing">Training with balancing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-on-balanced-sample">Training on balanced sample</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-selection">Model selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sanity-check">Sanity check</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="customer-churn">
<h1>Customer churn<a class="headerlink" href="#customer-churn" title="Link to this heading">#</a></h1>
<p>The customer bank is losing clients.</p>
<p>To stop or at least slow down this process, we need to make a list of clients who can potentially terminate the contract with the bank.</p>
<p>We will solve this problem using machine learning methods based on data about customer behavior. We will try to train the models on different variants of the original dataset so as to take into account the imbalance of classes.</p>
<p>Since this is a classification task, the main metrics of model quality will be F1-score and AUC-ROC.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sb</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span> 
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_recall_curve</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">plot_roc_curve</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
</pre></div>
</div>
</div>
</div>
<section id="data-preprocessing">
<h2>Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Churn.csv&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/datasets/Churn.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RowNumber</th>
      <th>CustomerId</th>
      <th>Surname</th>
      <th>CreditScore</th>
      <th>Geography</th>
      <th>Gender</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Exited</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>15634602</td>
      <td>Hargrave</td>
      <td>619</td>
      <td>France</td>
      <td>Female</td>
      <td>42</td>
      <td>2.0</td>
      <td>0.00</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>101348.88</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>15647311</td>
      <td>Hill</td>
      <td>608</td>
      <td>Spain</td>
      <td>Female</td>
      <td>41</td>
      <td>1.0</td>
      <td>83807.86</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>112542.58</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>15619304</td>
      <td>Onio</td>
      <td>502</td>
      <td>France</td>
      <td>Female</td>
      <td>42</td>
      <td>8.0</td>
      <td>159660.80</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>113931.57</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>15701354</td>
      <td>Boni</td>
      <td>699</td>
      <td>France</td>
      <td>Female</td>
      <td>39</td>
      <td>1.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>93826.63</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>15737888</td>
      <td>Mitchell</td>
      <td>850</td>
      <td>Spain</td>
      <td>Female</td>
      <td>43</td>
      <td>2.0</td>
      <td>125510.82</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>79084.10</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Features</p>
<ul class="simple">
<li><p>RowNumber — row index in the data</p></li>
<li><p>CustomerId — unique identifier of the customer</p></li>
<li><p>Surname — last name</p></li>
<li><p>CreditScore — credit rating</p></li>
<li><p>Geography — country of residence</p></li>
<li><p>Gender — gender</p></li>
<li><p>Age — age</p></li>
<li><p>Tenure — how many years a person has been a customer of the bank</p></li>
<li><p>Balance — account balance</p></li>
<li><p>NumOfProducts — number of bank products used by the client</p></li>
<li><p>HasCrCard — credit card presence</p></li>
<li><p>IsActiveMember — client’s activity</p></li>
<li><p>EstimatedSalary — estimated salary</p></li>
</ul>
<p>Target feature</p>
<ul class="simple">
<li><p>Exited - the fact that the client has left</p></li>
</ul>
<section id="feature-selection">
<h3>Feature selection<a class="headerlink" href="#feature-selection" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>We obviously do not need the RowNumber column, these numbers have nothing to do with the fact that the client left. Training the model with them will only deteriorate the quality.</p></li>
<li><p>CustomerID is probably not needed either. The only argument against it is that this number might reflect the order in which customers are registered (better to use date instead). I think it should be thrown out.</p></li>
<li><p>We probably don’t need the surname either. Unless there is some sting involved, they should not be associated with the fact of the client’s leaving.</p></li>
<li><p>The data in the other columns may be related to the client churn.</p></li>
<li><p>There are missing values in the <code class="docutils literal notranslate"><span class="pre">Tenure</span></code> column, which should be investigated.</p></li>
<li><p>I wonder how it is determined that the client is active.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;RowNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;CustomerId&#39;</span><span class="p">,</span> <span class="s1">&#39;Surname&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10000 entries, 0 to 9999
Data columns (total 11 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   CreditScore      10000 non-null  int64  
 1   Geography        10000 non-null  object 
 2   Gender           10000 non-null  object 
 3   Age              10000 non-null  int64  
 4   Tenure           9091 non-null   float64
 5   Balance          10000 non-null  float64
 6   NumOfProducts    10000 non-null  int64  
 7   HasCrCard        10000 non-null  int64  
 8   IsActiveMember   10000 non-null  int64  
 9   EstimatedSalary  10000 non-null  float64
 10  Exited           10000 non-null  int64  
dtypes: float64(3), int64(6), object(2)
memory usage: 859.5+ KB
</pre></div>
</div>
</div>
</div>
</section>
<section id="missing-values">
<h3>Missing values<a class="headerlink" href="#missing-values" title="Link to this heading">#</a></h3>
<p>Let’s have a look at the missing values in the <code class="docutils literal notranslate"><span class="pre">Tenure</span></code> column:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Tenure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CreditScore</th>
      <th>Geography</th>
      <th>Gender</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Exited</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>30</th>
      <td>591</td>
      <td>Spain</td>
      <td>Female</td>
      <td>39</td>
      <td>NaN</td>
      <td>0.00</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>140469.38</td>
      <td>1</td>
    </tr>
    <tr>
      <th>48</th>
      <td>550</td>
      <td>Germany</td>
      <td>Male</td>
      <td>38</td>
      <td>NaN</td>
      <td>103391.38</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>90878.13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>585</td>
      <td>Germany</td>
      <td>Male</td>
      <td>36</td>
      <td>NaN</td>
      <td>146050.97</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>86424.57</td>
      <td>0</td>
    </tr>
    <tr>
      <th>53</th>
      <td>655</td>
      <td>Germany</td>
      <td>Male</td>
      <td>41</td>
      <td>NaN</td>
      <td>125561.97</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>164040.94</td>
      <td>1</td>
    </tr>
    <tr>
      <th>60</th>
      <td>742</td>
      <td>Germany</td>
      <td>Male</td>
      <td>35</td>
      <td>NaN</td>
      <td>136857.00</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>84509.57</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>9944</th>
      <td>744</td>
      <td>Germany</td>
      <td>Male</td>
      <td>41</td>
      <td>NaN</td>
      <td>190409.34</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>138361.48</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9956</th>
      <td>520</td>
      <td>France</td>
      <td>Female</td>
      <td>46</td>
      <td>NaN</td>
      <td>85216.61</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>117369.52</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9964</th>
      <td>479</td>
      <td>France</td>
      <td>Male</td>
      <td>34</td>
      <td>NaN</td>
      <td>117593.48</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>113308.29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9985</th>
      <td>659</td>
      <td>France</td>
      <td>Male</td>
      <td>36</td>
      <td>NaN</td>
      <td>123841.49</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>96833.00</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9999</th>
      <td>792</td>
      <td>France</td>
      <td>Female</td>
      <td>28</td>
      <td>NaN</td>
      <td>130142.79</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>38190.78</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>909 rows × 11 columns</p>
</div></div></div>
</div>
<p>At first glance, there are no differences with the main dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d2337da70a396f230d2f0f45238d8beafca3f190fbfd5a6c7112b4827715855b.png" src="_images/d2337da70a396f230d2f0f45238d8beafca3f190fbfd5a6c7112b4827715855b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Tenure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e4279c25a04f10270a5db8f84890c4e48fbc6c5c85f7c4ce090fbd17a4aa158.png" src="_images/8e4279c25a04f10270a5db8f84890c4e48fbc6c5c85f7c4ce090fbd17a4aa158.png" />
</div>
</div>
<p>I guess not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Geography&#39;</span><span class="p">]</span>
 <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Geography&#39;</span><span class="p">]</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Tenure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
 <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1caf3d756cd5fb080c93769a04d443f9674e0395bc122fa8822a9106cbc43176.png" src="_images/1caf3d756cd5fb080c93769a04d443f9674e0395bc122fa8822a9106cbc43176.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span>
 <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Tenure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
 <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NaN&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/78b75288845ef14e1810f9a03fffd59df9911e4e650b0309c629bfec7ed15401.png" src="_images/78b75288845ef14e1810f9a03fffd59df9911e4e650b0309c629bfec7ed15401.png" />
</div>
</div>
<p>For categorical variables, too. It seems that the gaps have no logical explanation (i.e. random) and appeared as a result of a technical error.</p>
<p>The duration of the customer’s agreement with the bank is an important parameter. Unfortunately, these 10% of the dataset will have to be discarded (if only because sklearn models do not work with missing values and will not be able to account for other data in these rows).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Tenure&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encoding">
<h3>One-hot encoding<a class="headerlink" href="#one-hot-encoding" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<p>There are no explicit duplicates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># to avoid the dummy variable trap</span>
<span class="n">data_ohe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CreditScore</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Exited</th>
      <th>Geography_Germany</th>
      <th>Geography_Spain</th>
      <th>Gender_Male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>619</td>
      <td>42</td>
      <td>2.0</td>
      <td>0.00</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>101348.88</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>608</td>
      <td>41</td>
      <td>1.0</td>
      <td>83807.86</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>112542.58</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>502</td>
      <td>42</td>
      <td>8.0</td>
      <td>159660.80</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>113931.57</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>699</td>
      <td>39</td>
      <td>1.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>93826.63</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>850</td>
      <td>43</td>
      <td>2.0</td>
      <td>125510.82</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>79084.10</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>There are no implicit duplicates either, otherwise there would be extra columns.<br />
The <code class="docutils literal notranslate"><span class="pre">drop_first=True</span></code> argument threw out two columns.</p>
</section>
<section id="samples">
<h3>Samples<a class="headerlink" href="#samples" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="n">data_ohe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Exited&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">data_ohe</span><span class="p">[</span><span class="s1">&#39;Exited&#39;</span><span class="p">]</span>

<span class="p">(</span><span class="n">features_train</span><span class="p">,</span> 
 <span class="n">features_valid</span><span class="p">,</span> 
 <span class="n">features_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">),</span> 
                           <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))])</span>
<span class="p">(</span><span class="n">target_train</span><span class="p">,</span> 
 <span class="n">target_valid</span><span class="p">,</span> 
 <span class="n">target_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">),</span> 
                           <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_train</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CreditScore</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Geography_Germany</th>
      <th>Geography_Spain</th>
      <th>Gender_Male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2067</th>
      <td>744</td>
      <td>31</td>
      <td>9.0</td>
      <td>120718.28</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>58961.49</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>76</th>
      <td>664</td>
      <td>55</td>
      <td>8.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>139161.64</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2164</th>
      <td>767</td>
      <td>77</td>
      <td>8.0</td>
      <td>149083.70</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>190146.83</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6892</th>
      <td>649</td>
      <td>56</td>
      <td>8.0</td>
      <td>156974.26</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>89405.26</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7369</th>
      <td>644</td>
      <td>26</td>
      <td>4.0</td>
      <td>153455.72</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>82696.84</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3113</th>
      <td>620</td>
      <td>32</td>
      <td>7.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>34665.79</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9475</th>
      <td>616</td>
      <td>46</td>
      <td>2.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>137136.46</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7003</th>
      <td>646</td>
      <td>44</td>
      <td>2.0</td>
      <td>113063.83</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>53072.49</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4000</th>
      <td>520</td>
      <td>38</td>
      <td>5.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>163185.76</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4773</th>
      <td>646</td>
      <td>35</td>
      <td>1.0</td>
      <td>121952.75</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>142839.82</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5454 rows × 11 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_valid</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6380    1
4565    0
9322    0
604     0
5198    0
       ..
2830    0
7913    0
9126    1
3379    0
1757    1
Name: Exited, Length: 1818, dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-scaling">
<h3>Data scaling<a class="headerlink" href="#data-scaling" title="Link to this heading">#</a></h3>
<p>We perform scaling based on the training sample data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CreditScore&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;Tenure&#39;</span><span class="p">,</span> <span class="s1">&#39;Balance&#39;</span><span class="p">,</span> <span class="s1">&#39;NumOfProducts&#39;</span><span class="p">,</span> <span class="s1">&#39;EstimatedSalary&#39;</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">[</span><span class="n">numeric</span><span class="p">])</span>

<span class="n">features_train</span><span class="p">[</span><span class="n">numeric</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_train</span><span class="p">[</span><span class="n">numeric</span><span class="p">])</span>
<span class="n">features_valid</span><span class="p">[</span><span class="n">numeric</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_valid</span><span class="p">[</span><span class="n">numeric</span><span class="p">])</span>
<span class="n">features_test</span><span class="p">[</span><span class="n">numeric</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features_test</span><span class="p">[</span><span class="n">numeric</span><span class="p">])</span>
<span class="n">features_valid</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CreditScore</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Geography_Germany</th>
      <th>Geography_Spain</th>
      <th>Gender_Male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6380</th>
      <td>-0.500768</td>
      <td>-0.372859</td>
      <td>-1.369166</td>
      <td>0.750231</td>
      <td>-0.905589</td>
      <td>1</td>
      <td>0</td>
      <td>0.894022</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4565</th>
      <td>-0.603863</td>
      <td>0.663860</td>
      <td>-1.025266</td>
      <td>0.002282</td>
      <td>-0.905589</td>
      <td>1</td>
      <td>1</td>
      <td>-0.806120</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9322</th>
      <td>1.190006</td>
      <td>-0.372859</td>
      <td>1.382029</td>
      <td>-1.221631</td>
      <td>0.789943</td>
      <td>1</td>
      <td>0</td>
      <td>-1.065109</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>604</th>
      <td>0.519882</td>
      <td>-0.184364</td>
      <td>1.725928</td>
      <td>1.183536</td>
      <td>-0.905589</td>
      <td>1</td>
      <td>1</td>
      <td>-0.108046</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5198</th>
      <td>-0.490458</td>
      <td>0.098377</td>
      <td>-1.369166</td>
      <td>0.125591</td>
      <td>-0.905589</td>
      <td>0</td>
      <td>0</td>
      <td>-1.122351</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To summarize:</p>
<ol class="arabic simple">
<li><p>The training was conducted without taking into account indexing, client identifiers and client surnames, as these data are unlikely to be related to the reason why the client left.</p></li>
<li><p>9% missing at random data were found in the <code class="docutils literal notranslate"><span class="pre">Tenure</span></code> column. These rows were removed.</p></li>
<li><p>Two categorical variables, geographical location and client gender, were transformed using ohe-hot encoding, with data on one of countries and one of genders removed to avoid multicollinearity.</p></li>
<li><p>For numerical data, scaling was performed based on data from the training sample.</p></li>
</ol>
<p>Let’s train the model on data of this format.</p>
</section>
</section>
<section id="selection-functions">
<h2>Selection functions<a class="headerlink" href="#selection-functions" title="Link to this heading">#</a></h2>
<p>We will consider logistic regression, decision trees and random forest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plant_a_tree</span><span class="p">(</span><span class="n">def_features_train</span><span class="p">,</span> 
                 <span class="n">def_target_train</span><span class="p">,</span> 
                 <span class="n">def_features_valid</span><span class="p">,</span> 
                 <span class="n">def_target_valid</span><span class="p">,</span> 
                 <span class="n">balance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
        <span class="n">def_model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> 
                                           <span class="n">class_weight</span><span class="o">=</span><span class="n">balance</span><span class="p">,</span> 
                                           <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
        <span class="n">def_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">def_features_train</span><span class="p">,</span> <span class="n">def_target_train</span><span class="p">)</span>
        <span class="n">def_predicted_valid</span> <span class="o">=</span> <span class="n">def_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">def_features_valid</span><span class="p">)</span>
        <span class="n">current_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_f1</span> <span class="o">&gt;</span> <span class="n">best_f1</span><span class="p">:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">def_model</span>
            <span class="n">best_depth</span> <span class="o">=</span> <span class="n">depth</span>
            <span class="n">best_f1</span> <span class="o">=</span> <span class="n">current_f1</span>
            
    <span class="k">return</span> <span class="n">best_model</span>
</pre></div>
</div>
</div>
</div>
<p>Perhaps nested loops would give a more accurate result, but that’s too long, so let’s pick the depth first, then the number of trees.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plant_a_forest</span><span class="p">(</span><span class="n">def_features_train</span><span class="p">,</span> 
                   <span class="n">def_target_train</span><span class="p">,</span> 
                   <span class="n">def_features_valid</span><span class="p">,</span> 
                   <span class="n">def_target_valid</span><span class="p">,</span> 
                   <span class="n">balance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># %%time</span>
    <span class="n">best_depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
        <span class="n">def_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> 
                                           <span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> 
                                           <span class="n">class_weight</span><span class="o">=</span><span class="n">balance</span><span class="p">,</span> 
                                           <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
        <span class="n">def_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">def_features_train</span><span class="p">,</span> <span class="n">def_target_train</span><span class="p">)</span>
        <span class="n">def_predicted_valid</span> <span class="o">=</span> <span class="n">def_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">def_features_valid</span><span class="p">)</span>
        <span class="n">current_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_f1</span> <span class="o">&gt;</span> <span class="n">best_f1</span><span class="p">:</span>
            <span class="n">best_depth</span> <span class="o">=</span> <span class="n">depth</span>
            <span class="n">best_f1</span> <span class="o">=</span> <span class="n">current_f1</span>
    
    <span class="n">best_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_est</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">def_model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">est</span><span class="p">,</span> 
                                           <span class="n">max_depth</span><span class="o">=</span><span class="n">best_depth</span><span class="p">,</span> 
                                           <span class="n">class_weight</span><span class="o">=</span><span class="n">balance</span><span class="p">,</span> 
                                           <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
        <span class="n">def_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">def_features_train</span><span class="p">,</span> <span class="n">def_target_train</span><span class="p">)</span>
        <span class="n">def_predicted_valid</span> <span class="o">=</span> <span class="n">def_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">def_features_valid</span><span class="p">)</span>
        <span class="n">current_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_f1</span> <span class="o">&gt;</span> <span class="n">best_f1</span><span class="p">:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">def_model</span>
            <span class="n">best_est</span> <span class="o">=</span> <span class="n">est</span>
            <span class="n">best_f1</span> <span class="o">=</span> <span class="n">current_f1</span>
            
    <span class="k">return</span> <span class="n">best_model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">def_model</span><span class="p">,</span> <span class="n">def_features_valid</span><span class="p">,</span> <span class="n">def_target_valid</span><span class="p">):</span>
    <span class="n">def_predicted_valid</span> <span class="o">=</span> <span class="n">def_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">def_features_valid</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confusion matrix:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">))</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">),</span> 
                     <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Answers&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predictions&#39;</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">roc_graph</span><span class="p">(</span><span class="n">def_model</span><span class="p">,</span> <span class="n">def_features_valid</span><span class="p">,</span> <span class="n">def_target_valid</span><span class="p">):</span>
    <span class="n">def_predicted_valid</span> <span class="o">=</span> <span class="n">def_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">def_features_valid</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recall:&#39;</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision:&#39;</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F1-score:&#39;</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">def_target_valid</span><span class="p">,</span> <span class="n">def_predicted_valid</span><span class="p">))</span>
    
    <span class="n">plot_roc_curve</span><span class="p">(</span><span class="n">def_model</span><span class="p">,</span> <span class="n">def_features_valid</span><span class="p">,</span> <span class="n">def_target_valid</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="training-without-balancing">
<h2>Training without balancing<a class="headerlink" href="#training-without-balancing" title="Link to this heading">#</a></h2>
<section id="logistic-regression">
<h3>Logistic regression<a class="headerlink" href="#logistic-regression" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LogisticRegression:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression:
Accuracy: 0.8201320132013201 

Confusion matrix:
[[1417   60]
 [ 267   74]]
</pre></div>
</div>
<img alt="_images/f597487423c011170e878040b75ab1eae905f9bcff4d46e9c6f06b2d2e6a567d.png" src="_images/f597487423c011170e878040b75ab1eae905f9bcff4d46e9c6f06b2d2e6a567d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.21700879765395895
Precision: 0.5522388059701493
F1-score: 0.311578947368421
</pre></div>
</div>
<img alt="_images/f01b1d23223364dfc8af467f19b7c89907a06bd8fada67251189a055f5a589c7.png" src="_images/f01b1d23223364dfc8af467f19b7c89907a06bd8fada67251189a055f5a589c7.png" />
</div>
</div>
<p>So many type II errors.</p>
</section>
<section id="decision-tree">
<h3>Decision Tree<a class="headerlink" href="#decision-tree" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span> <span class="o">=</span> <span class="n">plant_a_tree</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DecisionTreeClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier:
Accuracy: 0.8641364136413642
Depth: 7 

Confusion matrix:
[[1405   72]
 [ 175  166]]
</pre></div>
</div>
<img alt="_images/3bf9a7c438ef1950d880c47c3b60f9e77c83eebe53275cea96ee09dfd4d59160.png" src="_images/3bf9a7c438ef1950d880c47c3b60f9e77c83eebe53275cea96ee09dfd4d59160.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.4868035190615836
Precision: 0.6974789915966386
F1-score: 0.5734024179620034
</pre></div>
</div>
<img alt="_images/fce18de37d1a2a95a22a444e5bc91a01d819d740b73fecc313c67056eb99bc67.png" src="_images/fce18de37d1a2a95a22a444e5bc91a01d819d740b73fecc313c67056eb99bc67.png" />
</div>
</div>
<p>Noticeable progress compared to regression. There are almost as many errors as correct answers (regarding the positive class).</p>
</section>
<section id="random-forest">
<h3>Random Forest<a class="headerlink" href="#random-forest" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">best_forest</span> <span class="o">=</span> <span class="n">plant_a_forest</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RandomForestClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimators:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier:
Accuracy: 0.8745874587458746
Depth: 18
Estimators: 22 

Confusion matrix:
[[1424   53]
 [ 175  166]]
</pre></div>
</div>
<img alt="_images/5a6b86578a3049a0eb1b6530443f5351a20f689d5e873d4c9558f27ab5e1ee28.png" src="_images/5a6b86578a3049a0eb1b6530443f5351a20f689d5e873d4c9558f27ab5e1ee28.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.4868035190615836
Precision: 0.7579908675799086
F1-score: 0.5928571428571429
</pre></div>
</div>
<img alt="_images/de07fadf2878c1443ca8d145cee92591f7874fd0a3c8fb64400e01ea6f008319.png" src="_images/de07fadf2878c1443ca8d145cee92591f7874fd0a3c8fb64400e01ea6f008319.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 49 s, sys: 298 ms, total: 49.3 s
Wall time: 49.3 s
</pre></div>
</div>
</div>
</div>
<p>AUC-ROC slightly increased, although one is predicted less frequently than in the decision tree. Apparently, it is connected with better prediction of zeros.</p>
<p>The metrics themselves are almost acceptable for models without class balancing, but the number of correctly found positive class objects has to be increased.</p>
</section>
</section>
<section id="training-with-balancing">
<h2>Training with balancing<a class="headerlink" href="#training-with-balancing" title="Link to this heading">#</a></h2>
<p>Now let’s look at the balance of the classes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_ohe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CreditScore</th>
      <th>Age</th>
      <th>Tenure</th>
      <th>Balance</th>
      <th>NumOfProducts</th>
      <th>HasCrCard</th>
      <th>IsActiveMember</th>
      <th>EstimatedSalary</th>
      <th>Exited</th>
      <th>Geography_Germany</th>
      <th>Geography_Spain</th>
      <th>Gender_Male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>619</td>
      <td>42</td>
      <td>2.0</td>
      <td>0.00</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>101348.88</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>608</td>
      <td>41</td>
      <td>1.0</td>
      <td>83807.86</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>112542.58</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>502</td>
      <td>42</td>
      <td>8.0</td>
      <td>159660.80</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>113931.57</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>699</td>
      <td>39</td>
      <td>1.0</td>
      <td>0.00</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>93826.63</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>850</td>
      <td>43</td>
      <td>2.0</td>
      <td>125510.82</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>79084.10</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_ohe</span><span class="p">[</span><span class="s1">&#39;Exited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    7237
1    1854
Name: Exited, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Let’s try to train with balance only.</p>
<section id="id1">
<h3>Logistic regression<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LogisticRegression:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression:
Accuracy: 0.7062706270627063 

Confusion matrix:
[[1056  421]
 [ 113  228]]
</pre></div>
</div>
<img alt="_images/3ece0dabe8beb75a161f082c3e8458e775af05e88d6fbcb6f20f2f4e610580c6.png" src="_images/3ece0dabe8beb75a161f082c3e8458e775af05e88d6fbcb6f20f2f4e610580c6.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.6686217008797654
Precision: 0.35130970724191063
F1-score: 0.46060606060606063
</pre></div>
</div>
<img alt="_images/b21e728824da705eac4ee2d9539d1a5974f99b74cf699d6e8b330aaeb153dbac.png" src="_images/b21e728824da705eac4ee2d9539d1a5974f99b74cf699d6e8b330aaeb153dbac.png" />
</div>
</div>
<p>This matrix is already more like what we would like to see. Too bad the ROC-AUC is low.</p>
</section>
<section id="id2">
<h3>Decision Tree<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span> <span class="o">=</span> <span class="n">plant_a_tree</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">,</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DecisionTreeClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier:
Accuracy: 0.7876787678767877
Depth: 8 

Confusion matrix:
[[1179  298]
 [  88  253]]
</pre></div>
</div>
<img alt="_images/425c9ad6ba6e006d14e381d024ef2b56f729f46b5258f99e441979a4d1ab7f2a.png" src="_images/425c9ad6ba6e006d14e381d024ef2b56f729f46b5258f99e441979a4d1ab7f2a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.7419354838709677
Precision: 0.4591651542649728
F1-score: 0.5672645739910314
</pre></div>
</div>
<img alt="_images/b1fa82b48717aa643695fbdf22e661ae50a23426c7dce508215b7ff79642f09a.png" src="_images/b1fa82b48717aa643695fbdf22e661ae50a23426c7dce508215b7ff79642f09a.png" />
</div>
</div>
<p>The tree is an even better predictor. Let’s see what happens with a random forest.</p>
</section>
<section id="id3">
<h3>Random Forest<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">best_forest</span> <span class="o">=</span> <span class="n">plant_a_forest</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">,</span> 
                             <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RandomForestClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimators:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier:
Accuracy: 0.858085808580858
Depth: 10
Estimators: 26 

Confusion matrix:
[[1344  133]
 [ 125  216]]
</pre></div>
</div>
<img alt="_images/510b00bdf74427d7e8df26d470a77ff985bd74757fa9e46f90bbf09c85ecc146.png" src="_images/510b00bdf74427d7e8df26d470a77ff985bd74757fa9e46f90bbf09c85ecc146.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.6334310850439883
Precision: 0.6189111747851003
F1-score: 0.6260869565217392
</pre></div>
</div>
<img alt="_images/b5af057252e531bc0798cab740150c7017beaf732dfe139fa310e693b1ab3b08.png" src="_images/b5af057252e531bc0798cab740150c7017beaf732dfe139fa310e693b1ab3b08.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 42.8 s, sys: 244 ms, total: 43.1 s
Wall time: 43 s
</pre></div>
</div>
</div>
</div>
<p>Here we observe a skewness.</p>
<p>The F1-score of the random forest is 0.626, which is higher than all previous models.</p>
<p>However, the error matrix shows that this was achieved due to the better prediction of zeros, while ones are predicted even worse than by the decision tree. This does not quite meet our goals. More than a third of our target customers stay unrecognized.</p>
<p>Let’s try to equalize the sample.</p>
</section>
</section>
<section id="training-on-balanced-sample">
<h2>Training on balanced sample<a class="headerlink" href="#training-on-balanced-sample" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ratio</span> <span class="o">=</span> <span class="n">data_ohe</span><span class="p">[</span><span class="s1">&#39;Exited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_ohe</span><span class="p">[</span><span class="s1">&#39;Exited&#39;</span><span class="p">])</span>
<span class="n">ratio</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.2039379606203938
</pre></div>
</div>
</div>
</div>
<p>Leaving customers in the dataset are 4 times less frequent than remaining customers. So the imbalance is 1:4.</p>
<p>The balance of classes is not so badly shifted. Let’s increase <strong>four times</strong> the number of positive lines and leave the number of negative lines unchanged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">upsample_downsample</span><span class="p">(</span><span class="n">def_features</span><span class="p">,</span> <span class="n">def_target</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">down</span><span class="p">):</span>
    <span class="n">features_zeros</span> <span class="o">=</span> <span class="n">def_features</span><span class="p">[</span><span class="n">def_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">features_ones</span> <span class="o">=</span> <span class="n">def_features</span><span class="p">[</span><span class="n">def_target</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">target_zeros</span> <span class="o">=</span> <span class="n">def_target</span><span class="p">[</span><span class="n">def_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">target_ones</span> <span class="o">=</span> <span class="n">def_target</span><span class="p">[</span><span class="n">def_target</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">features_sampled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_zeros</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">down</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)]</span> <span class="o">+</span> 
                                 <span class="p">[</span><span class="n">features_ones</span><span class="p">]</span> <span class="o">*</span> <span class="n">up</span><span class="p">)</span>
    <span class="n">target_sampled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">target_zeros</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">down</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)]</span> <span class="o">+</span> 
                                 <span class="p">[</span><span class="n">target_ones</span><span class="p">]</span> <span class="o">*</span> <span class="n">up</span><span class="p">)</span>
    
    <span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">features_sampled</span><span class="p">,</span> 
                                               <span class="n">target_sampled</span><span class="p">,</span> 
                                               <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">features_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">target_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5454, 11)
(5454,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span> <span class="o">=</span> <span class="n">upsample_downsample</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_sampled</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1    4476
0    4335
Name: Exited, dtype: int64
</pre></div>
</div>
</div>
</div>
<section id="id4">
<h3>Logistic regression<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;LogisticRegression:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression:
Accuracy: 0.7062706270627063 

Confusion matrix:
[[1056  421]
 [ 113  228]]
</pre></div>
</div>
<img alt="_images/3ece0dabe8beb75a161f082c3e8458e775af05e88d6fbcb6f20f2f4e610580c6.png" src="_images/3ece0dabe8beb75a161f082c3e8458e775af05e88d6fbcb6f20f2f4e610580c6.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.6686217008797654
Precision: 0.35130970724191063
F1-score: 0.46060606060606063
</pre></div>
</div>
<img alt="_images/6d8f4682564d4660e9b9ae215e70195879ea548f65d08ecbca1d9d2cbc91df38.png" src="_images/6d8f4682564d4660e9b9ae215e70195879ea548f65d08ecbca1d9d2cbc91df38.png" />
</div>
</div>
<p>Logistic regression returns the same result regardless of algorithm, number of iterations and multiplication of strings with positive objects. Only class weights can affect it.</p>
</section>
<section id="id5">
<h3>Decision Tree<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span> <span class="o">=</span> <span class="n">plant_a_tree</span><span class="p">(</span><span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">,</span> 
                         <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DecisionTreeClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_tree</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_tree</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DecisionTreeClassifier:
Accuracy: 0.7871287128712872
Depth: 8 

Confusion matrix:
[[1177  300]
 [  87  254]]
</pre></div>
</div>
<img alt="_images/faa3c2ee29998a3e60503a135e0a285cf3fb5ca021c93e211a9728ba987d38cc.png" src="_images/faa3c2ee29998a3e60503a135e0a285cf3fb5ca021c93e211a9728ba987d38cc.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.7448680351906158
Precision: 0.4584837545126354
F1-score: 0.5675977653631284
</pre></div>
</div>
<img alt="_images/d91d0ea717dc17b0999de2c8e585d200b6030306fdd0318caa07eec1eb9e4524.png" src="_images/d91d0ea717dc17b0999de2c8e585d200b6030306fdd0318caa07eec1eb9e4524.png" />
</div>
</div>
</section>
<section id="id6">
<h3>Random Forest<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">best_forest</span> <span class="o">=</span> <span class="n">plant_a_forest</span><span class="p">(</span><span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">,</span> 
                             <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RandomForestClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimators:&#39;</span><span class="p">,</span> <span class="n">best_forest</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">best_forest</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier:
Accuracy: 0.8591859185918592
Depth: 13
Estimators: 68 

Confusion matrix:
[[1344  133]
 [ 123  218]]
</pre></div>
</div>
<img alt="_images/760ba56b2ca4cc266e76cc0478e63f431df690061b33d985dcd781c43f654417.png" src="_images/760ba56b2ca4cc266e76cc0478e63f431df690061b33d985dcd781c43f654417.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.6392961876832844
Precision: 0.6210826210826211
F1-score: 0.630057803468208
</pre></div>
</div>
<img alt="_images/406f6b8e73c77756ecd18f6c805ef41ac1bf24d48ebe1722f5f3c6802896cbb9.png" src="_images/406f6b8e73c77756ecd18f6c805ef41ac1bf24d48ebe1722f5f3c6802896cbb9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1min 7s, sys: 229 ms, total: 1min 7s
Wall time: 1min 7s
</pre></div>
</div>
</div>
</div>
<p>It’s a little better compared to the original splitting.</p>
</section>
</section>
<section id="model-selection">
<h2>Model selection<a class="headerlink" href="#model-selection" title="Link to this heading">#</a></h2>
<p>The highest metric comes from models that give weights to classes and are built on samples where the ratio of zeros to ones is about 1:1 (that is, rows with positive objects are 4 times more common than originally).</p>
<p>Here are the statistics for the models:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Model</p></th>
<th class="head"><p>Recall</p></th>
<th class="head"><p>Precision</p></th>
<th class="head"><p>F1-score</p></th>
<th class="head"><p>AUC-ROC</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Logistic regression</p></td>
<td><p>0.669</p></td>
<td><p>0.351</p></td>
<td><p>0.461</p></td>
<td><p>0.76</p></td>
</tr>
<tr class="row-odd"><td><p>Decision tree</p></td>
<td><p><strong>0.745</strong></p></td>
<td><p>0.458</p></td>
<td><p>0.568</p></td>
<td><p>0.81</p></td>
</tr>
<tr class="row-even"><td><p>Random forest</p></td>
<td><p>0.639</p></td>
<td><p><strong>0.621</strong></p></td>
<td><p><strong>0.630</strong></p></td>
<td><p><strong>0.85</strong></p></td>
</tr>
</tbody>
</table>
</div>
<p>Here, the logistic regression is constructed using the liblinear algorithm, the decision tree has a depth of 8, and the random forest consists of 68 trees with a depth of 13.</p>
<p>Random forest has the highest F1-score, but it is achieved by recognizing zeros rather than ones.</p>
<p>This is where the question of business goals raises. If we need to retain as many customers as possible, recall is more important than accuracy, and I would take the decision tree even if it didn’t pass the F1 &gt; 0.59 threshold. However, since we have this requirement, let’s keep the random forest.</p>
</section>
<section id="sanity-check">
<h2>Sanity check<a class="headerlink" href="#sanity-check" title="Link to this heading">#</a></h2>
<p>To test the model for sanity, let’s compare it to a model that predicts classes based on their frequency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy_clf</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;stratified&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>
<span class="n">dummy_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">)</span>
<span class="n">dummy_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DummyClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">dummy_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">dummy_clf</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">dummy_clf</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DummyClassifier:
Accuracy: 0.6842684268426843 

Confusion matrix:
[[1172  305]
 [ 269   72]]
</pre></div>
</div>
<img alt="_images/a7ac6e547d19064c3ca2c5a9a86f783df391a13104028e425067bebc75fb52b7.png" src="_images/a7ac6e547d19064c3ca2c5a9a86f783df391a13104028e425067bebc75fb52b7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.21114369501466276
Precision: 0.1909814323607427
F1-score: 0.20055710306406685
</pre></div>
</div>
<img alt="_images/c2b71a131e6048cbd57e4a25108cf79225baff456a3ab2cdc1ae209f557f25b7.png" src="_images/c2b71a131e6048cbd57e4a25108cf79225baff456a3ab2cdc1ae209f557f25b7.png" />
</div>
</div>
<p>Or a model that predicts only positive class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy_clf</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dummy_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_train</span><span class="p">,</span> <span class="n">target_train</span><span class="p">)</span>
<span class="n">dummy_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DummyClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">dummy_clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># plot_confusion_matrix(dummy_clf, features_valid, target_valid)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">dummy_clf</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DummyClassifier:
Accuracy: 0.18756875687568758 

Recall: 1.0
Precision: 0.18756875687568758
F1-score: 0.3158869847151459
</pre></div>
</div>
<img alt="_images/cb72df49daa73104d60ca0601e1f6987997cf8d55ffe92e372e0bad0c0d7d137.png" src="_images/cb72df49daa73104d60ca0601e1f6987997cf8d55ffe92e372e0bad0c0d7d137.png" />
</div>
</div>
<p>The selected random forest has a slightly higher acuracy and a noticeably higher F1-score.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">68</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> 
                               <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">57</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features_sampled</span><span class="p">,</span> <span class="n">target_sampled</span><span class="p">)</span>
<span class="n">predicted_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RandomForestClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_test</span><span class="p">,</span> <span class="n">target_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimators:&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confusion matrix:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">predicted_test</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">predicted_test</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Answers&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predictions&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recall:&#39;</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">predicted_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision:&#39;</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">predicted_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F1-score:&#39;</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">target_test</span><span class="p">,</span> <span class="n">predicted_test</span><span class="p">))</span>
<span class="n">plot_roc_curve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">features_test</span><span class="p">,</span> <span class="n">target_test</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier:
Accuracy: 0.8328752061572292
Depth: 13
Estimators: 68 

Confusion matrix:
[[1283  142]
 [ 162  232]]
</pre></div>
</div>
<img alt="_images/d2e5765e0ba764d5c9a01351698f044e691936c08a1c1e7475d000718a64b2cb.png" src="_images/d2e5765e0ba764d5c9a01351698f044e691936c08a1c1e7475d000718a64b2cb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.5888324873096447
Precision: 0.6203208556149733
F1-score: 0.6041666666666666
</pre></div>
</div>
<img alt="_images/067b41951305f47c1bcd47a6e867931f17b7c53b1e95bb82adfdf64a402f4cc6.png" src="_images/067b41951305f47c1bcd47a6e867931f17b7c53b1e95bb82adfdf64a402f4cc6.png" />
</div>
</div>
<p>Recall has dropped significantly (0.639 =&gt; 0.589). F1-score also decreased (0.630 =&gt; 0.604), but still above the threshold.</p>
<p>Out of interest, let’s try to select a random forest with training on both test and validation samples.</p>
<p>The imbalance in the samples is preserved here and is taken into account only by the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perfect_forest</span> <span class="o">=</span> <span class="n">plant_a_forest</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_train</span><span class="p">,</span> <span class="n">features_valid</span><span class="p">]),</span> 
                                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">target_train</span><span class="p">,</span> <span class="n">target_valid</span><span class="p">]),</span> 
                                <span class="n">features_test</span><span class="p">,</span> 
                                <span class="n">target_test</span><span class="p">,</span> 
                                <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RandomForestClassifier:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accuracy:&#39;</span><span class="p">,</span> <span class="n">perfect_forest</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">features_test</span><span class="p">,</span> <span class="n">target_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Depth:&#39;</span><span class="p">,</span> <span class="n">perfect_forest</span><span class="o">.</span><span class="n">max_depth</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimators:&#39;</span><span class="p">,</span> <span class="n">perfect_forest</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">perfect_forest</span><span class="p">,</span> <span class="n">features_test</span><span class="p">,</span> <span class="n">target_test</span><span class="p">)</span>
<span class="n">roc_graph</span><span class="p">(</span><span class="n">perfect_forest</span><span class="p">,</span> <span class="n">features_test</span><span class="p">,</span> <span class="n">target_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RandomForestClassifier:
Accuracy: 0.8152831225948324
Depth: 8
Estimators: 22 

Confusion matrix:
[[1214  211]
 [ 125  269]]
</pre></div>
</div>
<img alt="_images/3866617f41f172fe6957e0c844daa0a1493779a3b91d44d35ce40b763bc19537.png" src="_images/3866617f41f172fe6957e0c844daa0a1493779a3b91d44d35ce40b763bc19537.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recall: 0.682741116751269
Precision: 0.5604166666666667
F1-score: 0.6155606407322655
</pre></div>
</div>
<img alt="_images/8764d77a6372e39d413e688a3064191a3a7da257dda1a17a73926adca1aa185c.png" src="_images/8764d77a6372e39d413e688a3064191a3a7da257dda1a17a73926adca1aa185c.png" />
</div>
</div>
<p>Both metrics have grown, but this is more of an overfitting effect, because the loop adjusts the hyperparameters to the metrics. Let’s leave it as it was.</p>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Model</p></th>
<th class="head"><p>Recall</p></th>
<th class="head"><p>Precision</p></th>
<th class="head"><p>F1-score</p></th>
<th class="head"><p>AUC-ROC</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Logistic regression</p></td>
<td><p>0.669</p></td>
<td><p>0.351</p></td>
<td><p>0.461</p></td>
<td><p>0.76</p></td>
</tr>
<tr class="row-odd"><td><p>Decision tree</p></td>
<td><p><strong>0.745</strong></p></td>
<td><p>0.458</p></td>
<td><p>0.568</p></td>
<td><p>0.81</p></td>
</tr>
<tr class="row-even"><td><p>Random forest</p></td>
<td><p>0.639</p></td>
<td><p><strong>0.621</strong></p></td>
<td><p><strong>0.630</strong></p></td>
<td><p><strong>0.85</strong></p></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic simple">
<li><p>There are 9% missing (most likely, accidentally) values among the data on the duration of customer agreement with the bank. These people were not taken into account in this work.</p></li>
<li><p>Class balancing noticeably improves the quality of the model. Both assigning weights to classes (according to imbalance) and increasing the frequency of occurrence of positive class objects (by a factor of 4) help significantly. Models using both are discussed below.</p></li>
<li><p>Logistic regression showed lower metric compared to the trees. Although it predicts leaving clients no worse than a random forest, it does much more type I errors.</p></li>
<li><p>Decision trees show good recall (at a depth of 8), but due to low precision it did not pass the threshold of 0.59. Depending on the objectives, this model can be taken into account.</p></li>
<li><p>Random forest has the highest score (with 68 trees of depth 13). Nevertheless, these numbers are achieved due to the good predictions for negative class objects, while the recall according to the test results leaves much to be desired.</p></li>
<li><p>According to the test results, F1-score was 0.604, recall - 0.589, i.e. the model tend to do type II errors.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tariff_recommendation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tariff recommendation</p>
      </div>
    </a>
    <a class="right-next"
       href="oil_bootstrap.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Selection of a location for a well</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data preprocessing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection">Feature selection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-values">Missing values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding">One-hot encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#samples">Samples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-scaling">Data scaling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selection-functions">Selection functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-without-balancing">Training without balancing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-with-balancing">Training with balancing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-on-balanced-sample">Training on balanced sample</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Logistic regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Decision Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-selection">Model selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sanity-check">Sanity check</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Leonid Dybovskii
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>